<!--
    TODO: (0) Verify that the outbound trip counter is actually correct (watch the map).
    TODO: (1) Add outbound trip counting to the tooltip and to the selection display.
    TODO: (2) Implement station colormap swapping between intro, stations, bikes modes.
    TODO: (3) Implement muting all non-selected stations a tad bit when the user has selections active.
    TODO: (4) Implement returning the sampler paths when the view is switched back to intro mode.
    TODO: (5) Implement box select.

    --- LATER ---
    TODO: (5) Plot station polylines on click (possibly with loading pane). HARD!
    TODO: (6) Possibly add box select? https://github.com/d3/d3-3.x-api-reference/blob/master/Drag-Behavior.md
    TODO: (7) Description, launch button text that loads on hover.
-->
<!DOCTYPE html>
<html>
<head>
    <title>A Day in the Life of CitiBike</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
        /* Note that I use a CSS control to change the cursor from a draggy hand to a regular one as well in order to */
        /* keep users from thinking it is interactive at the beginning. */
        /* This is necessary because to keep from distractions the intro animation has zoom and pan disabled. */
        .leaflet-container {
            cursor: default !important;
        }
        /* Station tooltip */
        .station-tip {
            line-height: 1.25;
            padding: 12px;
            background: whitesmoke;
            color: black;
            border-radius: 2px;
            font-family: Roboto;
            border:1px solid #999;
        }
        /* Pure CSS buttons! From http://cssdeck.com/labs/purely-css. Blue one first. */
        button.btn {
            display: inline-block;
            color: #666;
            background-color: #eee;
            text-transform: uppercase;
            font-size: 12px;
            padding: 10px 30px;
            border-radius: 5px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border: 1px solid rgba(0,0,0,0.3);
            border-bottom-width: 3px;
            cursor: pointer;
        }

        button.btn:hover {
            background-color: #e3e3e3;
            border-color: rgba(0,0,0,0.5);
        }

        button.btn:active {
            background-color: #CCC;
            border-color: rgba(0,0,0,0.9);
        }

        button.btn-disabled {
            display: inline-block;
            color: #aaa;
            border-color: #aaa;
            background: #e3e3e3;
            text-transform: uppercase;
            font-size: 12px;
            padding: 10px 30px;
            border-radius: 5px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border: 1px solid rgba(0,0,0,0.3);
            border-bottom-width: 3px;
        }

        button.btn.btn-blue {
            background-color: #699DB6;
            border-color: rgba(0,0,0,0.3);
            text-shadow: 0 1px 0 rgba(0,0,0,0.5);
            color: #FFF;
        }
        button.btn.btn-blue:hover {
            background-color: #4F87A2;
            border-color: rgba(0,0,0,0.5);
        }
        button.btn.btn-blue:active {
            background-color: #3C677B;
            border-color: rgba(0,0,0,0.9);
        }
    </style>


    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>
<body>

    <div id="map-canvas"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script src="/static/js/d3.v3.js"></script>
    <script src="/static/js/L.D3SvgOverlay.js"></script>
    <script>

        /////////////////////////
        // MAP INITIALIZATION  //
        /////////////////////////
        // About:
        // The map is Leaflet goodness, with all drawings and animations implemented on top using L.d3SvgOverlay.
        //

        // Initializes the basemap. Disable animations.
        var map = L.map("map-canvas", {
            zoomControl: false, // No zooming on initialization because it messes with the drawing.
            scrollWheelZoom: false
        });
        // Using Leaflet's fitBounds method ensures that the resultant map contains all of the points on all display
        // devices. The precise points were arrived at by the high scientific method of guess-and-check.
        map.fitBounds([[40.6794268,-73.92989109999999], [40.789747, -74.075979]]);
        // More disabling things.
        map.dragging.disable();
        map.keyboard.disable();
        map.doubleClickZoom.disable();
        // I also use a CSS control to change the cursor from a draggy hand to a regular one as well in order to
        // keep users from thinking it is interactive at the beginning.
        // Gib tile layer.
        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        // Thx.

        // D3-SVG-Overlay callback wrapper. Leaflet is used only for the base map, all of the programmatic action occurs
        // in d3 code inside of this callback.
        var mapOverlay = L.d3SvgOverlay(function(sel,proj){

            //////////////////////
            // INTRO ANIMATION  //
            //////////////////////
            // Design:
            // For the introduction I wanted to dynamically render a random set of paths (200 of them in the final
            // visualization) before painting the rest of the introductory scene.
            //
            // Implementation:
            // runIntroAnimation() -> paintPathSampler() -> paintPath()
            //                     -> paintBackgroundPanel()
            //                     -> paintStations()
            //                     -> drawInfoBox() [function from the "infobox" section, the intro adds a timeout]
            //
            // TODO: Scale station circle size to the zoom level selected by Leaflet. (later)


            // Paints a single sampler path. Accepts a linearray (an array of points) as input, as well as the position
            // of the line being drawn in placement order. paintPathSampler is the method which actually handles the
            // entire path-sampling introductory animation, and it implements this method over a loop to do that.
            function paintPath(linearray, index) {

                // Define the SVG line reprojection function.
                var line = d3.svg.line()
                        .x(function(d) { return proj.latLngToLayerPoint(d).x})
                        .y(function(d) { return proj.latLngToLayerPoint(d).y});

                // Create a path, bind the line array to its __data__, and call line on it to generate the line-code.
                setTimeout(function() {
                    sel.append('path').datum(linearray)
                            .attr({
                                "class": "sample-line",
                                "d": line,
                                "fill": "transparent",
                                "stroke": "white",
                                "stroke-width": 3,
                                "vector-effect": "non-scaling-stroke"
                            })
                            .transition()
                            .duration(2500)
                            .attr({
                                "stroke": "steelblue"
                            })
                }, 25*i);
            }

            // Paint all of the sampler paths. Wraps paintPath(), above, with consideration removing old paths.
            // The data file itself, `sample_trips.json`, was generated using Python---specifically the path_sampler.py
            // script.
            function paintPathSampler() {
                // Remove all of the existing paths first, otherwise we keep old ones!
                sel.selectAll('path').remove();

                d3.json("../../static/post_assets/citibike/sample_trips.json", function (data) {
                    for(i=0; i<data.length; i++) {
                        paintPath(data[i], i);
                    }
                });
            }

            // Fade the background to white after a certain amount of time. This background panel is then used as a
            // part of the animation transitions later on.
            function paintBackgroundPanel() {
                sel.append("rect")
                        .attr({
                            "fill": "#fff",
                            "width": "100%",
                            "height": "100%",
                            "fill-opacity": 0.0,
                            "class": "background-panel"
                        })
                        .transition()
                        .delay(3500)
                        .duration(2000)
                        .attr("fill-opacity", 0.65);
            }

            // Paints the stations on the map.
            function paintStations() {
                d3.csv("../../static/post_assets/citibike/july_22_station_metadata.csv", function(error, dataset) {
                    if (error) throw error;

                    // 1431 is the observed maximum bike trip count---Pershing Square North @ Grand Central Station.
                    var station_color_scale = d3.scale.linear().domain([0, 1500]).range(["#a7c4dd", "#152635"]);

                    setTimeout(function() {
                        sel
                                .append("g")
                                .selectAll("circle")
                                .data(dataset)
                                .enter()
                                .append("circle")
                                .attr({
                                    "class": "station",
                                    "cx": function (d) { return proj.latLngToLayerPoint([d.latitude, d.longitude]).x },
                                    "cy": function (d) { return proj.latLngToLayerPoint([d.latitude, d.longitude]).y },
                                    "r": 0,
                                    "stroke": "white",
                                    "stroke-width": 2,
                                    "cursor": "pointer",
                                    "fill": function(d) {
                                        if(d['kind'] == 'active') {
                                            return station_color_scale(d['all trips']);
                                        }
                                        else if(d['kind'] == 'inactive') {
                                            return "#ddbfa7";
                                        }
                                    }
                                })
                                .on('mouseover', function(d, i){
                                    d3.select(this)
                                        .attr({
                                            "stroke-width": 4,
                                            "r": 10
                                        });
                                    showTooltip(d);
                                })
                                .on('mouseout', function(d, i) {
                                    d3.select(this)
                                            .attr({
                                                "stroke-width": 2,
                                                "r": 5
                                            });
                                    hideTip();
                                })
                                .on("click", toggleStation)
                                .transition()
                                .duration(500)
                                .attr({
                                    "r": 5
                                })
                    }, 6000);
                });
            }

            // This function runs the intro animation.
            function runIntroAnimation() {
                paintPathSampler();  // Animate the sample paths.
                paintBackgroundPanel(); // Animate the background fadeout.
                paintStations();  // Animate the stations.
                setTimeout(function() {
                    paintIntroInfo(); // Append the intro text box. This method is from the Info Box code segment.
                }, 6000);
            }

            //////////////
            // INFO BOX //
            //////////////
            // Design:
            // Handles the information display on the left-hand side. A different one is created every time the viz
            // mode is switched.
            //
            // Implementation:
            // {paintIntroInfo(), paintStationsInfo(), paintBikesInfo()} -> drawInfoBox()
            //

            // Draws the info box. This method is used by the information pane painters (there are three, one for each
            // viz mode: intro, stations, bikes). Since the height and width and whatnot of the display depends on the
            // device, all of the sizing for this box are calculated with respect to extrema on the map.
            function drawInfoBox() {
                // Remove any pre-existing ones, we re-draw every time we return.
                d3.select("#description-block").remove();

                // Create the container.
                d3.select("#map-canvas")
                        .append("div")
                        .attr("id", "description-block")
                        .style({
                            "position": "absolute",
                            "width": "400px",
                            // It's easiest to just let height be whatever height the whole thing ends up at.
//                                "height": (proj.latLngToLayerPoint([40.70122128,-74.01234218]).y -
//                                            proj.latLngToLayerPoint([40.784642, -73.970002]).y) + "px",
                            "top": proj.latLngToLayerPoint([40.784642, -73.970002]).y + "px",
                            "left": proj.latLngToLayerPoint([40.704556, -74.026222]).x - 400 - 20 + "px",
                            // ^ (point in the Hudson river) - (width of the box) - (bit of additional padding).
                            "background": "#fff",
                            "border-radius": "25px",
                            "opacity": 0.0,
                            "padding": "10px",
                            "font-family": "Roboto",
                            "text-align": "center"
                        })
                        .transition()
                        .duration(2000)
                        .style({
                            "opacity": 1.0
                        });

                // Append title.
                d3.select("#description-block")
                        .append("div")
                        .style({
                            "font-size": "24px",
                            "font-weight": "bold"
                        })
                        .text("A Day in the Life of CitiBike");

            }

            // Paints the introductory info box.
            function paintIntroInfo() {
                drawInfoBox();

                var text_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "text-align": "left"
                        });
                var button_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "width": "100%",
                            "margin-top": "30px"
                        });

                d3.json("../../static/post_assets/citibike/content_descriptions.json", function (text) {
                    text_holder.html(text["intro"]);
                });

                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn btn-blue"
                        })
                        .style({
                            "width": "50%"
                        })
                        .text("Follow Stations")
                        .on("click", function() {
                            switchToStationsMode();
                        });

                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn btn-blue"
                        })
                        .style({
                            "width": "50%"
                        })
                        .text("Follow Bikes")
                        .on("click", function() {
                            switchToBikesMode();
                        });

            }

            // Removes everything from the selection. Used by the Reset GUI element. It's factored out because it's
            // common to both functions.
            // This really ought to be in the station selection block, but for some reason when it's there it breaks my
            // build.
            function clearSelection() {
                d3.selectAll(".station").attr({
                    "stroke": "white"
                });
                selected_stations = {};
                updateSelectionDisplay();
                updateResetButtonStyle();
            }

            // This helper function creates and appends a button that when in station mode or in bike mode and hit
            // bounces you back to the intro. It's factored out because it's common to both functions.
            function appendMenuGoBack(button_holder) {
                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn"
                        })
                        .style({
                            "width": "33%"
                        })
                        .text("Go Back")
                        .on("click", function() {
                            switchToIntroMode();
                        });
            }

            // This helper function creates and appends a button that when in station mode or in bike mode and hit
            // removes all of the stations in your current selection. It's factored out because it's common to both
            // functions.
            function appendMenuReset(button_holder) {
                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn-disabled",
                            "id": "reset-button"
                        })
                        .style({
                            "width": "33%"
                        })
                        .text("Reset")
                        .on("click", function() {
                            clearSelection();  // in the station selection section.
                        });
                updateResetButtonStyle();  // Necessary in case there are preexisting selections.
            }

            // Paints the stations info box.
            function paintStationsInfo() {
                drawInfoBox();

                var text_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "text-align": "left"
                        });
                var button_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "width": "100%",
                            "margin-top": "30px"
                        });

                d3.json("../../static/post_assets/citibike/content_descriptions.json", function (text) {
                    text_holder.html(text["stations"]);
                });

                appendMenuGoBack(button_holder);
                appendMenuReset(button_holder);

                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn btn-blue"
                        })
                        .style({
                            "width": "33%"
                        })
                        .text("Launch")
                        .on("click", function() {
                            // TODO: Implement.
                        });

            }

            // Paints the bikes info box.
            function paintBikesInfo() {
                drawInfoBox();

                var text_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "text-align": "left"
                        });
                var button_holder = d3.select("#description-block")
                        .append("div")
                        .style({
                            "width": "100%",
                            "margin-top": "30px"
                        });

                d3.json("../../static/post_assets/citibike/content_descriptions.json", function (text) {
                    text_holder.html(text["bikes"]);
                });

                appendMenuGoBack(button_holder);
                appendMenuReset(button_holder);

                button_holder.append("button")
                        .attr({
                            "type": "button",
                            "class": "btn btn-blue"
                        })
                        .style({
                            "width": "33%"
                        })
                        .text("Launch")
                        .on("click", function() {
                            // TODO: Implement.
                        });

            }

            ///////////////////////
            // STATION SELECTION //
            ///////////////////////
            // Design:
            // This code handles when a user clicks on a station, uses the box select, or hits clear selection.
            //
            // Implementation:
            // In order to implement the station toggle selection we need to implement a global struct which stores
            // stations selected and the paths that have been drawn associated with them. The structure is thus:
            // {'<first station id>':
            //      { 'station':<first station selection>,
            //        'trips': [<first trip selection>, <second trip selection>, ...]
            //      }
            //  '<second station id>':
            //      { ... }
            //  ...
            // }
            // This data structure is unware of what the provenance of the trips it stores is, it merely stores them.
            // Accessing trips allows us to do either/or of the two viz modes.
            // They're stored under stations to allow implementing a highlighter later on.
            var selected_stations = {};
            var viz_mode = 'intro';  // options are 'intro', 'stations', 'bikes'. We start in 'intro'.

            // Now the function itself. As a UX decision I decided to split *generating* a selection from plotting its
            // data. I did this to allow doing selections on the introduction pane, before the user chooses a
            // visualization mode. For a UX standpoint this is necessary because not having that there would make it
            // awkward for the user to realize that they can click on things later.
            //
            // From a developer standpoint this means that selected_stations can contain just stations without any data
            // bound to them, necessitating that, on triggering a visualization mode, we call a function which checks
            // and binds data to the current selection, if necessary. It also requires a global flag for what mode
            // the visualization is in, intro or stations or bikes. This is `viz_mode` above.
            function toggleStation(d) {
                var sel_station = d3.select(this);
                // Do nothing if the station is inactive.
                if(d['kind'] == 'active') {
                    if(!(d['station id'] in selected_stations)) {
                        // Station is not currently in the selection, so add it.
                        selected_stations[d['station id']] = sel_station;
                        if(!(viz_mode == 'intro')) {
                            // We are not currently on the introduction screen, so we can't just bind the element, we have
                            // to fire populating the lines as well.
                            // TODO: Implement this. Requires working the API first.
                        }
                        // Change the circle mark to match.
                        sel_station.attr({"stroke": "black"});
                    }
                    else {
                        // The element is already in the selection, so remove it (this is a toggle after all).
                        delete selected_stations[d['station id']];
                        // Update the display element.
                        // Change the circle mark to match.
                        sel_station.attr({"stroke": "white"});
                    }
                    // Update the display elements.
                    updateSelectionDisplay();
                    updateResetButtonStyle();
                }
            }

            // The following helper method updates the selection display.
            // It is called by toggleStation() whenever a station is added to the selection or removed from it.
            function updateSelectionDisplay() {
                var selection_size = Object.keys(selected_stations).length;
                if(selection_size == 0) {
                    // If no stations are selected then we just removed our last selection, so remove the display.
                    d3.select("#selection-display").remove();
                }
                else {
                    // If there's just one selection that means we just selected our first station.
                    // So create the display element.
                    // Note: the display element is drawn on the HTML map canvas level, not the SVG level. This is
                    // because it's rather difficult to get an SVG box into the top right corner, but trivial to
                    // do so in HTML.
                    d3.select("#selection-display").remove();
                    d3.select("#map-canvas").append("div")
                            .attr({
                                "id": "selection-display"
                            })
                            .style({
                                "position": "absolute",
                                "top": "20px",
                                "right": "20px",
                                "width": "400px",
                                "background": "transparent",
//                                    "border": "1px solid black",
                                "text-align": "right"
                            })
                            .html(function(d) {
                                // Deal with pluralization!
                                var s = "";
                                if(selection_size > 1) {
                                    s = "s";
                                }
                                // Get total trip counts.
                                // TODO: Write this logic and add it to the display.
                                // Write the string.
                                return "<div style='font-weight: bold; font-size: 24px; font-family:Roboto;'>" +
                                        selection_size + " Station" + s + " Selected</div>"
                            });
                }

            }

            function updateResetButtonStyle() {
                var selection_size = Object.keys(selected_stations).length;
                if(selection_size == 0) {
                    // If no stations are selected then we just removed our last selection, so remove the display.
                    d3.select("#reset-button").attr({"class": "btn-disabled"});
                }
                else {
                    d3.select("#reset-button").attr({"class": "btn"});
                }
            }

            /////////////
            // TOOLTIP //
            /////////////
            // Design:
            // On hovering over one of the stations a tooltip displays with information on what that station is. Super
            // useful for navigation purposes.
            //
            // Implementation:
            // I originally hoped I could use d3.tip for this (and implemented it that way) but it turns out that
            //  d3.tip cannot deal with projections at all, so I have to hard-code my own tooltip design.
            //

            // Displays the appropriate tooltip for the selected station.
            function showTooltip(d) {
                var sel_station = d3.select(this);
                d3.select("#map-canvas")
                        .append("div")
                        .attr({"class": "station-tip"})
                        .style({
                            "position": "absolute",
                            "top": proj.latLngToLayerPoint([d['latitude'], d['longitude']]).y -
                                   35 + "px",
                            "left": proj.latLngToLayerPoint([d['latitude'], d['longitude']]).x + 20 + "px"
                        })
                        .html(function() {
                            var underline = null;
                            if(d['kind'] == 'inactive') {
                                underline = "Out of Service" + "</span></div>";
                            }
                            else {
                                if(viz_mode == 'intro') {
                                    underline = d['all trips'] +
                                            " Trips To/From, " +
                                            d['outbound trips'] + " Trips Outbound" +
                                            "</span></div>";  // TODO: Change this to a dual-display one liner.
                                    // Format for one-liner: 445 Trips to/from Station; 1020 Outbound Trips
                                    // Or something like that.
                                }
                                else if(viz_mode == 'stations') {
                                    underline = d['all trips'] +
                                    " &#128690; Trips ("
                                    + d['incoming trips']
                                    + " In, "
                                    + d['outgoing trips'] + " Out)"
                                    + "</span></div>";
                                }
                                else if(viz_mode == 'bikes') {
                                    underline =  d['bikes outbound'] +
                                    " &#128690; Starts ("
                                    + d['outbound trips']
                                    + " Trips Total)"
                                    + "</span></div>";
                                }
                            }
                            return "<div style='text-align:center'>" +
                                "<span style='font-weight:bold; font-size:16px;'>" +
                                d['station name'] +
                                "</span><br/><span style='font-size:12px;'>" + underline;
                        });
            }

            // Removes the tooltip.
            function hideTip() {
                d3.select(".station-tip").remove();
            }

            ////////////////////
            // MODAL SWITCHES //
            ////////////////////
            // Design:
            // When you click the modal buttons, this code takes you to that visualization mode. What happens then is
            // TBD.
            //

            // Once you have gotten as far as selecting a visualization type the sampler paths go bye-bye.
            function fadeOutSamplerPaths() {
                var sample_lines = d3.selectAll(".sample-line");
                sample_lines
                        .transition()
                        .duration(2000)
                        .style({"opacity": 0})
                        .remove();
            }

            function switchToBikesMode() {
                viz_mode = "bikes";
                fadeOutSamplerPaths();
                paintBikesInfo();
            }

            function switchToStationsMode() {
                viz_mode = "stations";
                fadeOutSamplerPaths();
                paintStationsInfo();
            }

            function switchToIntroMode() {
                viz_mode = "intro";
                paintIntroInfo();
            }

            /////////////////
            // MAIN METHOD //
            /////////////////
            // This is the method runs the whole thing.
            // No seriously. That's it.
            // Everything else hooks into this one call.
            // Ain't JavaScript a beaut?
            runIntroAnimation();

        });

        /////////////
        // RUNTIME //
        /////////////
        // That was a d3SvgOverlay callback, the execution of which is handled by this one-liner.
        mapOverlay.addTo(map);
    </script>
</body>
</html>