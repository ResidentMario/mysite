<!DOCTYPE html>
<html>
<head>
    <title>A Week in the Life of a CitiBike</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
        /*Note that I use a CSS control to change the cursor from a draggy hand to a regular one as well in order to*/
        /*keep users from thinking it is interactive at the beginning.*/
        /*This is necessary because to keep from distractions the intro animation has zoom and pan disabled.*/
        .leaflet-container {
            cursor: default !important;
        }
    </style>


    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>
<body>
    <div id="map-canvas"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script src="/static/js/d3.v3.js"></script>
    <script src="https://d3js.org/d3-queue.v3.js"></script>
    <script src="/static/js/L.D3SvgOverlay.js"></script>
    <script>

        // Initializes the basemap.
        var map = L.map("map-canvas", {
            center: [40.7270355,-74.0143414,13],
            zoom: 13,
            zoomControl: false, // No zooming on initialization because it messes with the drawing.
            scrollWheelZoom: false
        });
        // No panning either, for the same reason.
        map.dragging.disable();
        // Note that I use a CSS control to change the cursor from a draggy hand to a regular one as well in order to
        // keep users from thinking it is interactive at the beginning.
        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // D3-SVG-Overlay callback wrapper. Leaflet is used only for the base map, all of the programmatic action occurs
        // in d3 code inside of this callback.
        var mapOverlay = L.d3SvgOverlay(function(sel,proj){

            // Paints a single sampler path.
            // Accepts a linearray (an array of points) as input, as well as the position of the line being drawn in
            // placement order (used to implement the intro visualization speedup).
            // Note that this method is called every time that the paths must be redrawn, and since the paths are
            // redrawn (by L.d3SvgOverlay) every time the zoom level is changed, each time that occurs all of the paths
            // have to be deleted and recreated. This method only handles creating one single line again; the
            // paintPointPath method, which is what is actually called every time a redraw occurs, handles deleting and
            // recalling this function to re-plot all of the lines.
            function paintPath(linearray, index) {

                // Define the SVG line reprojection function.
                var line = d3.svg.line()
                        .x(function(d) { return proj.latLngToLayerPoint(d).x})
                        .y(function(d) { return proj.latLngToLayerPoint(d).y});

                // Create a path, bind the line array to its __data__, and call line on it to generate the line-code.
                // TODO: More points! Muh ha ha.
                setTimeout(function() {
                    sel.append('path').datum(linearray)
                            .attr({
                                "class": "sample-line",
                                "d": line,
                                "fill": "transparent",
                                "stroke": "white",
                                "stroke-width": 3,
                                "vector-effect": "non-scaling-stroke"
                            })
                            .transition()
                            .duration(2500)
                            .attr({
                                "stroke": "steelblue"
                            })
                }, 25*i);
            }

            // Paint all of the sampler paths. Wraps paintPath(), above, with consideration removing old paths.
            function paintPathSampler() {
                // Remove all of the existing paths first, otherwise we keep old ones!
                sel.selectAll('path').remove();

                d3.json("../../static/post_assets/citibike/bike_week_sampler.json", function (data) {
                    for(i=0; i<data.length; i++) {
                        console.log(i);
                        paintPath(data[i], i);
                    }
                });
            }

            // Simple test method.
            function delayedHello() {
                setTimeout(function() {
                    console.log("Hello!");
              }, 10);
            }

            // Waits the amount of time necessary to let the animation finish and pulls up the information screen.
            function displayInfo() {

                sel.append("rect")
                        .attr({
                            "fill": "#eee",
                            "width": "100%",
                            "height": "100%",
                            "fill-opacity": 0.0
                        })
                        .transition()
                        .delay(4000)
                        .duration(2500)
                        .attr("fill-opacity", 1);

                // TODO: Implement a frame around the line draw.
                // TODO: As further transitions, populate the info text and the Watch A Bike buttons.
            }

            // SVG images preserve the order of the elements that are placed on them, so the information pane's overlay
            // (with transparent opacity) must be placed first, and the sampler points afterwards.
            paintPathSampler();
            displayInfo();
//            q = d3.queue();
//            q.defer(paintPathSampler);
//            q.defer(delayedHello);
//            q.await(function(error) {
//                if (error) throw error;
//                console.log("Goodbye!");
//            });

        });

        // Add overlay to map.
        mapOverlay.addTo(map);
    </script>
</body>
</html>