<!--
    TODO: (0) Cross-device compatibility fixes.
    TODO: (1) Station selection (toggle on click).
    TODO: (2) Station select counter in the corner.
    TODO: (3) Populate interface buttons.
    TODO: (4) Populate interface text.
    TODO: (5) Plot station polylines on click (possibly with loading pane). HARD!
    TODO: (6) Possibly add box select?
    TODO: (7) Description, launch button text that loads on hover.
    TODO: (8) Investigate the handful of stations which have no rides that day, but ought to have.
-->
<!DOCTYPE html>
<html>
<head>
    <title>A Day in the Life of CitiBike</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
        /*Note that I use a CSS control to change the cursor from a draggy hand to a regular one as well in order to*/
        /*keep users from thinking it is interactive at the beginning.*/
        /*This is necessary because to keep from distractions the intro animation has zoom and pan disabled.*/
        .leaflet-container {
            cursor: default !important;
        }
        /*Code for d3.tip*/
        .d3-tip {
            line-height: 1.25;
            padding: 12px;
            background: whitesmoke;
            color: black;
            border-radius: 2px;
            font-family: Roboto;
            border:1px solid #999;
        }
    </style>


    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>
<body>
    <div id="map-canvas"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script src="/static/js/d3.v3.js"></script>
    <!--<script src="https://d3js.org/d3-queue.v3.js"></script>-->
    <script src="/static/js/L.D3SvgOverlay.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script>

        // Initializes the basemap. Disable animations.
        var map = L.map("map-canvas", {
            zoomControl: false, // No zooming on initialization because it messes with the drawing.
            scrollWheelZoom: false
        });
        // Using Leaflet's fitBounds method ensures that the resultant map contains all of the points on all display
        // devices.
//        map.setView(new L.LatLng(40.7300355,-74.0143414,13));
        map.fitBounds([[40.6794268,-73.92989109999999], [40.789747, -74.075979]]);
        // More disabling things.
        map.dragging.disable();
        map.keyboard.disable();
        map.doubleClickZoom.disable();
        // Note that I use a CSS control to change the cursor from a draggy hand to a regular one as well in order to
        // keep users from thinking it is interactive at the beginning.
        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // D3-SVG-Overlay callback wrapper. Leaflet is used only for the base map, all of the programmatic action occurs
        // in d3 code inside of this callback.
        var mapOverlay = L.d3SvgOverlay(function(sel,proj){

            // Paints a single sampler path.
            // Accepts a linearray (an array of points) as input, as well as the position of the line being drawn in
            // placement order (used to implement the intro visualization speedup).
            // Note that this method is called every time that the paths must be redrawn, and since the paths are
            // redrawn (by L.d3SvgOverlay) every time the zoom level is changed, each time that occurs all of the paths
            // have to be deleted and recreated. This method only handles creating one single line again; the
            // paintPointPath method, which is what is actually called every time a redraw occurs, handles deleting and
            // recalling this function to re-plot all of the lines.
            function paintPath(linearray, index) {

                // Define the SVG line reprojection function.
                var line = d3.svg.line()
                        .x(function(d) { return proj.latLngToLayerPoint(d).x})
                        .y(function(d) { return proj.latLngToLayerPoint(d).y});

                // Create a path, bind the line array to its __data__, and call line on it to generate the line-code.
                setTimeout(function() {
                    sel.append('path').datum(linearray)
                            .attr({
                                "class": "sample-line",
                                "d": line,
                                "fill": "transparent",
                                "stroke": "white",
                                "stroke-width": 3,
                                "vector-effect": "non-scaling-stroke"
                            })
                            .transition()
                            .duration(2500)
                            .attr({
                                "stroke": "steelblue"
                            })
                }, 25*i);
            }

            // Paint all of the sampler paths. Wraps paintPath(), above, with consideration removing old paths.
            function paintPathSampler() {
                // Remove all of the existing paths first, otherwise we keep old ones!
                sel.selectAll('path').remove();

                d3.json("../../static/post_assets/citibike/sample_trips.json", function (data) {
                    for(i=0; i<data.length; i++) {
                        paintPath(data[i], i);
                    }
                });
            }

            // Waits the amount of time necessary to let the into anim finish and pulls up the intro screen.
            function displayInfo() {

                // Fade the background to white after a certain amount of time.
                sel.append("rect")
                        .attr({
                            "fill": "#fff",
                            "width": "100%",
                            "height": "100%",
                            "fill-opacity": 0.0,
                            "class": "background-panel"
                        })
                        .transition()
                        .delay(3500)
                        .duration(2000)
                        .attr("fill-opacity", 0.65);

                // Append the intro text (body) after a certain amount of time.
                // I want to align the description with the map, but the exact position of the map (in terms of its y
                // coordinates) varies with the height of the screen. So I was a little bit clever and calculated the
                // x and y coordinates of the northmost CitiBike station, using the projection, and then calculated a
                // pixel offset from there.
                setTimeout(function() {
                    d3.select("#map-canvas")
                            .append("div")
                            .attr("id", "description-block")
                            .style({
                                "position": "absolute",
                                "width": "400px",
                                "height": "640px",
                                "top": proj.latLngToLayerPoint([40.784642, -73.970002]).y + "px",
                                "left": proj.latLngToLayerPoint([40.784642, -73.970002]).x - 720 + "px",
                                "background": "#fff",
                                "border-radius": "25px",
                                "opacity": 0.0,
                                "padding": "10px"
                            })
                            .transition()
                            .duration(2000)
                            .style({
                                "opacity": 1.0
                            });

                    // Append title.
                    d3.select("#description-block")
                            .append("div")
                            .style({
                                "font-size": "24px",
                                "font-family": "Roboto",
                                "font-weight": "bold",
                                "text-align": "center"
                            })
                            .text("A Day in the Life of CitiBike")
                }, 6000);

            }

            // Paints the stations on the map.
            function paintStations() {
                d3.csv("../../static/post_assets/citibike/july_22_station_metadata.csv", function(error, dataset) {
                    if (error) throw error;

                    // 1431 is the observed maximum bike trip count---Pershing Square North @ Grand Central Station.
                    var station_color_scale = d3.scale.linear().domain([0, 1500]).range(["#a7c4dd", "#152635"]);

                    setTimeout(function() {
                        sel
                                .append("g")
                                .selectAll("circle")
                                .data(dataset)
                                .enter()
                                .append("circle")
                                .attr({
                                    "cx": function (d) { return proj.latLngToLayerPoint([d.latitude, d.longitude]).x },
                                    "cy": function (d) { return proj.latLngToLayerPoint([d.latitude, d.longitude]).y },
                                    "r": 0,
                                    "stroke": "white",
                                    "stroke-width": 2,
                                    "cursor": "pointer",
                                    "fill": function(d) { return station_color_scale(d['all trips']); }
                                })
                                .on('mouseover', function(d, i){
                                    d3.select(this)
                                        .attr({
                                            "stroke-width": 4,
                                            "r": 10
                                        });
                                    tip.show(d, i);
                                })
                                .on('mouseout', function(d, i) {
                                    d3.select(this)
                                            .attr({
                                                "stroke-width": 2,
                                                "r": 5
                                            });
                                    tip.hide(d, i);
                                })
                                .on("click", toggleStation)
                                .transition()
                                .duration(500)
                                .attr({
                                    "r": 5
                                })
                    }, 6000);
                });
            }

            // Now for toggle-selecting a station. This is called directly when the user clicks on a station,
            // and indirectly by the box zoom tool.

            // In order to implement the station toggle selection we need to implement a global struct which stores
            // stations selected and the paths that have been drawn associated with them. The structure is thus:
            // {'<first station id>':
            //      { 'station':<first station selection>,
            //        'trips': [<first trip selection>, <second trip selection>, ...]
            //      }
            //  '<second station id>':
            //      { ... }
            // ...
            // }
            // This data structure is unware of what the provenance of the trips it stores is, it merely stores them.
            // Accessing trips allows us to do either/or of the two viz modes.
            // They're stored under stations to allow implementing a highlighter later on.
            var selected_stations = {};
            var viz_mode = 'intro';  // options are 'intro', 'stations', 'bikes'. We start in 'intro'.

            // Now the function itself. As a UX decision I decided to split *generating* a selection from plotting its
            // data. I did this to allow doing selections on the introduction pane, before the user chooses a
            // visualization mode. For a UX standpoint this is necessary because not having that there would make it
            // awkward for the user to realize that they can click on things later.
            //
            // From a developer standpoint this means that selected_stations can contain just stations without any data
            // bound to them, necessitating that, on triggering a visualization mode, we call a function which checks
            // and binds data to the current selection, if necessary. It also requires a global flag for what mode
            // the visualization is in, intro or stations or bikes. This is `viz_mode` above.
            function toggleStation(d) {
                var sel_station = d3.select(this);
                if(!(d['station id'] in selected_stations)) {
                    // Station is not currently in the selection, so add it.
                    selected_stations[d['station id']] = sel_station;
                    if(!(viz_mode == 'intro')) {
                        // We are not currently on the introduction screen, so we can't just bind the element, we have
                        // to fire populating the lines as well.
                        // TODO: Implement this. Requires working the API first.
                    }
                    // Update the display element.
                    updateSelectionDisplay();
                    // Change the circle mark to match.
                    sel_station.attr({"stroke": "black"});
                }
                else {
                    // The element is already in the selection, so remove it (this is a toggle after all).
                    delete selected_stations[d['station id']];
                    // Update the display element.
                    updateSelectionDisplay();
                    // Change the circle mark to match.
                    sel_station.attr({"stroke": "white"});
                }
            }

            // The following helper method updates the selection display.
            // It is called by toggleStation() whenever a station is added to the selection or removed from it.
            function updateSelectionDisplay() {
                var selection_size = Object.keys(selected_stations).length;
                if(selection_size == 0) {
                    // If no stations are selected then we just removed our last selection, so remove the display.
                    d3.select("#selection-display").remove();
                }
                else {
                    // If there's just one selection that means we just selected our first station.
                    // So create the display element.
                    // Note: the display element is drawn on the HTML map canvas level, not the SVG level. This is
                    // because it's rather difficult to get an SVG box into the top right corner, but trivial to
                    // do so in HTML.
                    d3.select("#selection-display").remove();
                    d3.select("#map-canvas").append("div")
                            .attr({
                                "id": "selection-display"
                            })
                            .style({
                                "position": "absolute",
                                "top": "20px",
                                "right": "20px",
                                "width": "400px",
                                "background": "transparent",
//                                    "border": "1px solid black",
                                "text-align": "right"
                            })
                            .html(function(d) {
                                // Deal with pluralization!
                                var s = "";
                                if(selection_size > 1) {
                                    s = "s";
                                }
                                // Get total trip counts.
                                // TODO: Write this logic and add it to the display.
                                // Write the string.
                                return "<div style='font-weight: bold; font-size: 24px; font-family:Roboto;'>" +
                                        selection_size + " Station" + s + " Selected</div>"
                            });
                }
            }

            // Set up the display tip, which displays on hovering over a station.
            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset(function() {
                    return [-20, -30]
                })
                .html(function(d) {
                    return  "<div style='text-align:center'>" +
                            "<span style='font-weight:bold; font-size:16px;'>" +
                            d['station name'] +
                            "</span><br/><span style='font-size:12px;'>" +
                            d['all trips'] +
                            " &#128690; Trips ("
                            + d['incoming trips']
                            + " In, "
                            + d['outgoing trips'] + " Out)"
                            + "</span></div>";
            });
            sel.call(tip);

            // SVG images preserve the order of the elements that are placed on them, so the information pane's overlay
            // (with transparent opacity) must be placed first, and the sampler points afterwards.
            paintPathSampler();
            displayInfo();
            paintStations();
//            q = d3.queue();
//            q.defer(paintPathSampler);
//            q.defer(delayedHello);
//            q.await(function(error) {
//                if (error) throw error;
//                console.log("Goodbye!");
//            });

        });

        // Add overlay to map.
        mapOverlay.addTo(map);
    </script>
</body>
</html>